<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GERENCIAR CURSO</title>
    <link rel="stylesheet" href="/css/header2.css" />
    <link rel="stylesheet" href="/css/curso_prof.css" />
    <link rel="stylesheet" href="/css/p_gere_curso.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      /* Estilos para os módulos */
      .modulo-bloco {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        overflow: hidden;
      }
      
      .modulo-header {
        background-color: #f8f9fa;
        padding: 15px 20px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .modulo-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
      }
      
      .modulo-actions {
        display: flex;
        gap: 10px;
      }
      
      .modulo-body {
        padding: 20px;
      }
      
      /* Estilos para a lista de aulas */
      .aulas {
        margin-top: 20px;
      }
      
      .aulas h5 {
        font-size: 1.1rem;
        margin-bottom: 15px;
        color: #495057;
      }
      
      .list-group-item {
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .list-group-item:hover {
        background-color: #f8f9fa;
      }
      
      .list-group-item h6 {
        margin-bottom: 5px;
      }
      
      /* Estilos para o modal de aula */
      .modal-header {
        border-bottom: 1px solid #e9ecef;
        padding: 1rem 1.5rem;
      }
      
      .modal-footer {
        border-top: 1px solid #e9ecef;
        padding: 1rem 1.5rem;
      }
      
      .modal-body {
        padding: 1.5rem;
      }
      
      /* Ajustes para campos de formulário */
      .form-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
      }
      
      .form-text {
        font-size: 0.8rem;
        color: #6c757d;
      }
      
      /* Botões */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 5px;
      }
      
      .btn i {
        font-size: 0.9em;
      }
      
      /* Responsividade */
      @media (max-width: 768px) {
        .modulo-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }
        
        .modulo-actions {
          width: 100%;
          justify-content: flex-end;
        }
      }
    </style>
    <link
      rel="shortcut icon"
      href="/images/favicon.ico"
      type="image/x-icon"
    />
  </head>
  <body>
    <header>
      <a href="./p-curso_prof">
        <img src="/images/voltar.svg" alt="Voltar"/>
      </a>
      <p>GERENCIAR CURSO</p>
      <div>
        <p><%= user.NOME_USU || 'Professor' %></p>
        <button
          class="user-icon"
          id="userIcon"
          aria-label="Abrir menu do usuário"
        >
          <img src="/images/perfil.svg" alt="imagem do perfil" />
          <div class="user-config" id="userConfig">
            <ul>
              <li><a href="./p-professor">MENU</a></li>
              <li><a href="./p-config">CONFIGURAÇÕES</a></li>
              <li><a href="/auth/logout">SAIR</a></li>
            </ul>
          </div>
        </button>
      </div>
    </header>

    <div class="container">
      <form action="/dashboard/professor/p_gere_curso/<%= curso.ID_CURSO %>" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="curso_id" value="<%= curso.ID_CURSO %>">
        
        <div class="left">
          <h1>DETALHES DO CURSO</h1>

          <div class="form-group">
            <label for="titulo">NOME DO CURSO</label>
            <input
              type="text"
              id="titulo"
              name="titulo"
              required
              placeholder="Adicione um nome..."
              value="<%= curso.TITULO %>"
              disabled
            />
          </div>


          <div class="form-group">
            <label for="descricao">DESCRIÇÃO</label>
            <textarea 
              id="descricao" 
              name="descricao" 
              required
              placeholder="Adicione uma descrição..."
              disabled
            ><%= curso.DESCRICAO %></textarea>
          </div>

          <div class="form-group">
            <label for="categoria">CATEGORIA</label>
            <select id="categoria" name="categoria" required disabled>
              <option value="">Selecione uma categoria...</option>
              <% categorias.forEach(function(categoria) { %>
                <option value="<%= categoria.ID_CATEGORIA %>" 
                        <%= curso.ID_CATEGORIA == categoria.ID_CATEGORIA ? 'selected' : '' %>>
                  <%= categoria.NOME %>
                </option>
              <% }); %>
            </select>
          </div>

          <div class="form-group">
            <label for="preco">PREÇO (R$)</label>
            <input
              type="number"
              id="preco"
              name="preco"
              step="0.01"
              min="0"
              placeholder="Ex: 99.90"
              required
              value="<%= curso.PRECO %>"
              disabled
            />
          </div>

          <div class="form-group">
            <label for="duracao_total">DURAÇÃO TOTAL (horas)</label>
            <input
              type="number"
              id="duracao_total"
              name="duracao_total"
              step="0.1"
              min="0"
              placeholder="Ex: 10.5"
              required
              value="<%= curso.DURACAO_TOTAL %>"
              disabled
            />
          </div>

          <div class="form-group">
            <label for="objetivos">OBJETIVOS</label>
            <textarea 
              id="objetivos" 
              name="objetivos" 
              required
              placeholder="Descreva os objetivos do curso..."
              disabled
            ><%= curso.OBJETIVOS %></textarea>
          </div>
        </div>

        <div class="botoes-edicao">
          <button type="button" id="btnEditar">Editar</button>
          <button type="submit" id="btnSalvar" style="display:none;">Salvar</button>
          <button type="button" id="btnExcluirCurso" style="background:#e74c3c;color:#fff;">Excluir Curso</button>
        </div>

        <!-- Modal de confirmação -->
        <div id="modalConfirm" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:1000;align-items:center;justify-content:center;">
          <div style="background:#fff;padding:2em;border-radius:8px;max-width:90vw;box-shadow:0 2px 16px #0002;text-align:center;">
            <h2>Confirmar Exclusão</h2>
            <p>Tem certeza que deseja excluir este curso? Esta ação não pode ser desfeita.</p>
            <form id="formExcluirCurso" method="POST" action="/dashboard/professor/excluir_curso/<%= curso.ID_CURSO %>" style="margin-top:1em;">
              <button type="submit" style="background:#e74c3c;color:#fff;padding:0.5em 1.5em;margin-right:1em;">Excluir</button>
              <button type="button" id="btnCancelarExclusao" style="background:#bbb;padding:0.5em 1.5em;">Cancelar</button>
            </form>
          </div>
        </div>

        <script>
          const btnEditar = document.getElementById('btnEditar');
          const btnSalvar = document.getElementById('btnSalvar');
          const form = document.querySelector('form');
          btnEditar.addEventListener('click', function() {
            form.querySelectorAll('input, textarea, select').forEach(el => {
              if (el.name !== 'curso_id') el.disabled = false;
            });
            btnSalvar.style.display = '';
            btnEditar.style.display = 'none';
          });
        </script>

        <hr>
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Módulos do Curso</h2>
  <button type="button" id="addModuloBtn" class="btn btn-primary">
    <i class="fas fa-plus"></i> Adicionar Módulo
  </button>
</div>
<div id="modulosContainer">
  <!-- Os módulos serão renderizados aqui pelo CursoManager -->
</div>
<!-- Campos ocultos -->
<input type="hidden" name="modulos" id="modulos-json">
<input type="hidden" name="modulosExcluidos" id="modulosExcluidos-json">
<input type="hidden" name="aulasExcluidas" id="aulasExcluidas-json">

<script>
  // Inicializa o CursoManager com os módulos do servidor
  document.addEventListener('DOMContentLoaded', function() {
    // Converte os módulos do formato do servidor para o formato esperado pelo CursoManager
    const modulosFormatados = Array.isArray(<%- JSON.stringify(modulos) || '[]' %>) ? 
      <%- JSON.stringify(modulos) || '[]' %>.map(modulo => ({
        titulo: modulo.TITULO || '',
        descricao: modulo.DESCRICAO || '',
        ID_MODULO: modulo.ID_MODULO || null,
        ORDEM: modulo.ORDEM || 0,
        aulas: (modulo.aulas || []).map(aula => ({
          titulo: aula.TITULO || aula.NOME || '',
          descricao: aula.DESCRICAO || '',
          duracao: aula.DURACAO || '',
          ID_AULA: aula.ID_AULA || null,
          ORDEM: aula.ORDEM || 0
        }))
      })) : [];
    
    // Armazena os módulos formatados para o CursoManager
    window.cursoModulos = modulosFormatados;
    
    // Inicializa o gerenciador de módulos
    if (window.CursoManager) {
      CursoManager.init();
      
      // Configura o envio do formulário
      const form = document.querySelector('form');
      if (form) {
        form.onsubmit = function(e) {
          e.preventDefault();
          
          // Atualiza os campos ocultos antes do envio
          const modulosInput = document.getElementById('modulos-json');
          const modulosExcluidosInput = document.getElementById('modulosExcluidos-json');
          const aulasExcluidasInput = document.getElementById('aulasExcluidas-json');
          
          if (modulosInput) {
            modulosInput.value = JSON.stringify(CursoManager.modulos);
          }
          
          // Mantém o rastreamento de módulos e aulas excluídos
          if (modulosExcluidosInput) {
            modulosExcluidosInput.value = JSON.stringify(window.modulosExcluidos || []);
          }
          
          if (aulasExcluidasInput) {
            aulasExcluidasInput.value = JSON.stringify(window.aulasExcluidas || []);
          }
          
          // Submete o formulário
          form.submit();
        };
      }
    }
  });
  
  // Funções globais para compatibilidade com o código existente
  window.adicionarModulo = function() {
    if (window.CursoManager) {
      CursoManager.addModulo();
    }
  };
  
  window.excluirModulo = function(index) {
    if (window.CursoManager && window.CursoManager.modulos[index]) {
      // Adiciona à lista de módulos excluídos se tiver ID
      if (window.CursoManager.modulos[index].ID_MODULO) {
        window.modulosExcluidos = window.modulosExcluidos || [];
        window.modulosExcluidos.push(CursoManager.modulos[index].ID_MODULO);
      }
      CursoManager.removeModulo(index);
    }
  };
  
  window.excluirAula = function(moduloIndex, aulaIndex) {
    if (window.CursoManager && 
        CursoManager.modulos[moduloIndex] && 
        CursoManager.modulos[moduloIndex].aulas && 
        CursoManager.modulos[moduloIndex].aulas[aulaIndex]) {
      
      // Adiciona à lista de aulas excluídas se tiver ID
      if (CursoManager.modulos[moduloIndex].aulas[aulaIndex].ID_AULA) {
        window.aulasExcluidas = window.aulasExcluidas || [];
        window.aulasExcluidas.push(CursoManager.modulos[moduloIndex].aulas[aulaIndex].ID_AULA);
      }
      
      CursoManager.removeAula(moduloIndex, aulaIndex);
    }
  };
</script>

      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/simple-notify/dist/simple-notify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Wait for DOM to be fully loaded
      document.addEventListener('DOMContentLoaded', function() {
        // User menu toggle
        const userIcon = document.getElementById('userIcon');
        const userMenu = document.getElementById('userConfig');
        
        if (userIcon && userMenu) {
          userIcon.addEventListener('click', function(e) {
            e.stopPropagation();
            userMenu.style.display = userMenu.style.display === 'block' ? 'none' : 'block';
          });

          // Close menu when clicking outside
          document.addEventListener('click', function(e) {
            if (!userIcon.contains(e.target) && !userMenu.contains(e.target)) {
              userMenu.style.display = 'none';
            }
          });
        }
      });
    </script>
    <script src="/js/curso.js"></script>
    
    <!-- Modal para adicionar/editar aula -->
    <div class="modal fade" id="aulaModal" tabindex="-1" aria-labelledby="aulaModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="aulaModalLabel">Nova Aula</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <form id="aulaForm" onsubmit="event.preventDefault(); CursoManager.saveAulaFromModal();">
            <div class="modal-body">
              <div class="mb-3">
                <label for="titulo" class="form-label">Título da Aula <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="titulo" name="titulo" required>
              </div>
              
              <div class="mb-3">
                <label for="descricao" class="form-label">Descrição</label>
                <textarea class="form-control" id="descricao" name="descricao" rows="3"></textarea>
              </div>
              
              <div class="mb-3">
                <label for="tipo_conteudo" class="form-label">Tipo de Conteúdo</label>
                <select class="form-select" id="tipo_conteudo" name="tipo_conteudo" onchange="CursoManager.toggleVideoFields()">
                  <option value="video">Vídeo</option>
                  <option value="texto">Texto</option>
                </select>
              </div>
              
              <div id="videoUrlGroup">
                <div class="mb-3">
                  <label for="video_url" class="form-label">URL do Vídeo (Youtube/Vimeo)</label>
                  <input type="url" class="form-control" id="video_url" name="video_url" 
                         placeholder="https://www.youtube.com/watch?v=...">
                  <div class="form-text">Insira a URL completa do vídeo</div>
                </div>
                
                <div class="mb-3">
                  <label for="video_arquivo" class="form-label">Ou envie um arquivo de vídeo</label>
                  <input type="file" class="form-control" id="video_arquivo" name="video_arquivo" 
                         accept="video/*">
                  <div class="form-text">Formatos suportados: MP4, WebM, OGG (Máx. 500MB)</div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="duracao" class="form-label">Duração (HH:MM:SS) <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="duracao" name="duracao" 
                           pattern="([01]?[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]" 
                           placeholder="00:10:00" required>
                    <div class="form-text">Formato: HH:MM:SS (ex: 00:15:30 para 15 minutos e 30 segundos)</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="ordem" class="form-label">Ordem no Módulo <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="ordem" name="ordem" min="1" required>
                    <div class="form-text">A ordem em que esta aula aparecerá no módulo</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">Salvar Aula</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <script>
      // Modal exclusão
      document.getElementById('btnExcluirCurso').onclick = function() {
        document.getElementById('modalConfirm').style.display = 'flex';
      };
      document.getElementById('btnCancelarExclusao').onclick = function() {
        document.getElementById('modalConfirm').style.display = 'none';
      };
      
      // Inicializa tooltips
      document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });
      });
    </script>
  </body>
</html>
