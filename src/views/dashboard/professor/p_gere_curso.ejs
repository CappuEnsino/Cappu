<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GERENCIAR CURSO</title>
    <link rel="stylesheet" href="/css/p_gere_curso.css" />
    <link rel="stylesheet" href="/css/header2.css" />
    <link
      rel="shortcut icon"
      href="/images/favicon.ico"
      type="image/x-icon"
    />
  </head>
  <body>
    <header>
      <a href="./p-curso_prof">
        <img src="/images/voltar.svg" alt="Voltar"/>
      </a>
      <p>GERENCIAR CURSO</p>
      <div>
        <p><%= user.NOME_USU || 'Professor' %></p>
        <button
          class="user-icon"
          id="userIcon"
          aria-label="Abrir menu do usuário"
        >
          <img src="/images/perfil.svg" alt="imagem do perfil" />
          <div class="user-config" id="userConfig">
            <ul>
              <li><a href="./p-professor">MENU</a></li>
              <li><a href="./p-config">CONFIGURAÇÕES</a></li>
              <li><a href="/auth/logout">SAIR</a></li>
            </ul>
          </div>
        </button>
      </div>
    </header>

    <div class="container">
      <form action="/dashboard/professor/p_gere_curso/<%= curso.ID_CURSO %>" method="POST">
        <input type="hidden" name="curso_id" value="<%= curso.ID_CURSO %>">
        
        <div class="left">
          <h1>DETALHES DO CURSO</h1>

          <div class="form-group">
            <label for="titulo">NOME DO CURSO</label>
            <input
              type="text"
              id="titulo"
              name="titulo"
              required
              placeholder="Adicione um nome..."
              value="<%= curso.TITULO %>"
              disabled
            />
          </div>


          <div class="form-group">
            <label for="descricao">DESCRIÇÃO</label>
            <textarea 
              id="descricao" 
              name="descricao" 
              required
              placeholder="Adicione uma descrição..."
              disabled
            ><%= curso.DESCRICAO %></textarea>
          </div>

          <div class="form-group">
            <label for="categoria">CATEGORIA</label>
            <select id="categoria" name="categoria" required disabled>
              <option value="">Selecione uma categoria...</option>
              <% categorias.forEach(function(categoria) { %>
                <option value="<%= categoria.ID_CATEGORIA %>" 
                        <%= curso.ID_CATEGORIA == categoria.ID_CATEGORIA ? 'selected' : '' %>>
                  <%= categoria.NOME %>
                </option>
              <% }); %>
            </select>
          </div>

          <div class="form-group">
            <label for="preco">PREÇO (R$)</label>
            <input
              type="number"
              id="preco"
              name="preco"
              step="0.01"
              min="0"
              placeholder="Ex: 99.90"
              required
              value="<%= curso.PRECO %>"
              disabled
            />
          </div>

          <div class="form-group">
            <label for="duracao_total">DURAÇÃO TOTAL (horas)</label>
            <input
              type="number"
              id="duracao_total"
              name="duracao_total"
              step="0.1"
              min="0"
              placeholder="Ex: 10.5"
              required
              value="<%= curso.DURACAO_TOTAL %>"
              disabled
            />
          </div>

          <div class="form-group">
            <label for="objetivos">OBJETIVOS</label>
            <textarea 
              id="objetivos" 
              name="objetivos" 
              required
              placeholder="Descreva os objetivos do curso..."
              disabled
            ><%= curso.OBJETIVOS %></textarea>
          </div>
        </div>

        <div class="botoes-edicao">
          <button type="button" id="btnEditar">Editar</button>
          <button type="submit" id="btnSalvar" style="display:none;">Salvar</button>
          <button type="button" id="btnExcluirCurso" style="background:#e74c3c;color:#fff;">Excluir Curso</button>
        </div>

        <!-- Modal de confirmação -->
        <div id="modalConfirm" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:1000;align-items:center;justify-content:center;">
          <div style="background:#fff;padding:2em;border-radius:8px;max-width:90vw;box-shadow:0 2px 16px #0002;text-align:center;">
            <h2>Confirmar Exclusão</h2>
            <p>Tem certeza que deseja excluir este curso? Esta ação não pode ser desfeita.</p>
            <form id="formExcluirCurso" method="POST" action="/dashboard/professor/excluir_curso/<%= curso.ID_CURSO %>" style="margin-top:1em;">
              <button type="submit" style="background:#e74c3c;color:#fff;padding:0.5em 1.5em;margin-right:1em;">Excluir</button>
              <button type="button" id="btnCancelarExclusao" style="background:#bbb;padding:0.5em 1.5em;">Cancelar</button>
            </form>
          </div>
        </div>

        <script>
          const btnEditar = document.getElementById('btnEditar');
          const btnSalvar = document.getElementById('btnSalvar');
          const form = document.querySelector('form');
          btnEditar.addEventListener('click', function() {
            form.querySelectorAll('input, textarea, select').forEach(el => {
              if (el.name !== 'curso_id') el.disabled = false;
            });
            btnSalvar.style.display = '';
            btnEditar.style.display = 'none';
          });
        </script>

        <hr>
<h2>Módulos do Curso</h2>
<div id="modulosContainer">
  <!-- Os módulos serão renderizados aqui pelo CursoManager -->
</div>
<button type="button" id="addModuloBtn">Adicionar Novo Módulo</button>
<!-- Campos ocultos -->
<input type="hidden" name="modulos" id="modulos-json">
<input type="hidden" name="modulosExcluidos" id="modulosExcluidos-json">
<input type="hidden" name="aulasExcluidas" id="aulasExcluidas-json">

<script>
  // Inicializa o CursoManager com os módulos do servidor
  document.addEventListener('DOMContentLoaded', function() {
    // Converte os módulos do formato do servidor para o formato esperado pelo CursoManager
    const modulosFormatados = Array.isArray(<%- JSON.stringify(modulos) || '[]' %>) ? 
      <%- JSON.stringify(modulos) || '[]' %>.map(modulo => ({
        titulo: modulo.TITULO || '',
        descricao: modulo.DESCRICAO || '',
        ID_MODULO: modulo.ID_MODULO || null,
        ORDEM: modulo.ORDEM || 0,
        aulas: (modulo.aulas || []).map(aula => ({
          titulo: aula.TITULO || aula.NOME || '',
          descricao: aula.DESCRICAO || '',
          duracao: aula.DURACAO || '',
          ID_AULA: aula.ID_AULA || null,
          ORDEM: aula.ORDEM || 0
        }))
      })) : [];
    
    // Armazena os módulos formatados para o CursoManager
    window.cursoModulos = modulosFormatados;
    
    // Inicializa o gerenciador de módulos
    if (window.CursoManager) {
      CursoManager.init();
      
      // Configura o envio do formulário
      const form = document.querySelector('form');
      if (form) {
        form.onsubmit = function(e) {
          e.preventDefault();
          
          // Atualiza os campos ocultos antes do envio
          const modulosInput = document.getElementById('modulos-json');
          const modulosExcluidosInput = document.getElementById('modulosExcluidos-json');
          const aulasExcluidasInput = document.getElementById('aulasExcluidas-json');
          
          if (modulosInput) {
            modulosInput.value = JSON.stringify(CursoManager.modulos);
          }
          
          // Mantém o rastreamento de módulos e aulas excluídos
          if (modulosExcluidosInput) {
            modulosExcluidosInput.value = JSON.stringify(window.modulosExcluidos || []);
          }
          
          if (aulasExcluidasInput) {
            aulasExcluidasInput.value = JSON.stringify(window.aulasExcluidas || []);
          }
          
          // Submete o formulário
          form.submit();
        };
      }
    }
  });
  
  // Funções globais para compatibilidade com o código existente
  window.adicionarModulo = function() {
    if (window.CursoManager) {
      CursoManager.addModulo();
    }
  };
  
  window.excluirModulo = function(index) {
    if (window.CursoManager && window.CursoManager.modulos[index]) {
      // Adiciona à lista de módulos excluídos se tiver ID
      if (window.CursoManager.modulos[index].ID_MODULO) {
        window.modulosExcluidos = window.modulosExcluidos || [];
        window.modulosExcluidos.push(CursoManager.modulos[index].ID_MODULO);
      }
      CursoManager.removeModulo(index);
    }
  };
  
  window.excluirAula = function(moduloIndex, aulaIndex) {
    if (window.CursoManager && 
        CursoManager.modulos[moduloIndex] && 
        CursoManager.modulos[moduloIndex].aulas && 
        CursoManager.modulos[moduloIndex].aulas[aulaIndex]) {
      
      // Adiciona à lista de aulas excluídas se tiver ID
      if (CursoManager.modulos[moduloIndex].aulas[aulaIndex].ID_AULA) {
        window.aulasExcluidas = window.aulasExcluidas || [];
        window.aulasExcluidas.push(CursoManager.modulos[moduloIndex].aulas[aulaIndex].ID_AULA);
      }
      
      CursoManager.removeAula(moduloIndex, aulaIndex);
    }
  };
</script>

      </form>
    </div>

    <script src="/js/icon-menu.js"></script>
    <script src="/js/curso.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-notify/dist/simple-notify.min.js"></script>
    <script>
      // Modal exclusão
      document.getElementById('btnExcluirCurso').onclick = function() {
        document.getElementById('modalConfirm').style.display = 'flex';
      };
      document.getElementById('btnCancelarExclusao').onclick = function() {
        document.getElementById('modalConfirm').style.display = 'none';
      };
    </script>
  </body>
</html>
